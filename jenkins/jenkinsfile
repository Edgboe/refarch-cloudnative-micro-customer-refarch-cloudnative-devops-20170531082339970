podTemplate(label: 'mypod',
    volumes: [hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock'),
              secretVolume(secretName: 'bx-auth-secret', mountPath: '/var/run/secrets/bx-auth-secret')],
    containers: [
        containerTemplate(
            name: 'gradle',
            image: 'fabiogomezdiaz/bc-jenkins-slave:v9',
            alwaysPullImage: true,
            ttyEnabled: true,
            command: 'cat'
    )]) {

    node ('mypod') {
        container('gradle') {
            stage ('Build') {
                checkout scm
                sh """
                #!/bin/bash

                ./gradlew build -x test
                """
            }
            stage ('Build Docker Image') {
                sh """
                #!/bin/bash

                export REGISTRY_NAMESPACE=chrisking

                ./gradlew docker 
                cd docker && docker build -t registry.ng.bluemix.net/${env.REGISTRY_NAMESPACE}/micro-customer:${env.BUILD_NUMBER} .
                """
            }
            stage ('Push Docker Image to Registry') {
                sh """
                #!/bin/bash

                export REGISTRY_NAMESPACE=chrisking

                # Install plugins
                bx plugin install container-registry -r Bluemix

                # TODO: use API key instead of password?

                # Login to Bluemix and init plugins
                bx login -a api.ng.bluemix.net \
                -u `cat /var/run/secrets/bx-auth-secret/CF_EMAIL` \
                -p `cat /var/run/secrets/bx-auth-secret/CF_PASSWORD` \
                -c `cat /var/run/secrets/bx-auth-secret/CF_ACCOUNT` \
                -o `cat /var/run/secrets/bx-auth-secret/CF_ORG` \
                -s `cat /var/run/secrets/bx-auth-secret/CF_SPACE`

                # initialize container registry plugin
                bx cr login

                # push image into bluemix private registry
                docker push registry.ng.bluemix.net/${env.REGISTRY_NAMESPACE}/micro-customer:${env.BUILD_NUMBER}
                """
            }
            stage ('Bind services to cluster') {
                sh """
                #!/bin/bash

                # Install plugins

                bx plugin install container-service -r Bluemix
                bx cs init

                # find cloudant service
                export CLOUDANT_SVC_NAME=`bx service list | grep cloudantNoSQLDB | sed -e 's/[ ]*cloudantNoSQLDB.*$//'`

                if [ -z "${env.CLOUDANT_SVC_NAME}" ]; then
                  echo "No Cloudant service found!"
                  exit 1
                fi

                # bind it to kube secret
                echo "Binding cloudant service ${env.CLOUDANT_SVC_NAME} to cluster ${env.KUBE_CLUSTER_NAME}
                export KUBE_CLUSTER_NAME=`kubectl config view | yaml r - current-context`
                bx cs cluster-service-bind ${env.KUBE_CLUSTER_NAME} default ${env.CLOUDANT_SVC_NAME}

                """
            }
            stage ('Deploy pod to Kubernetes') {
                sh """
                #!/bin/bash

                export CLOUDANT_SVC_NAME=`bx service list | grep cloudantNoSQLDB | sed -e 's/[ ]*cloudantNoSQLDB.*$//'`

                # TODO: get the secret name from the service name?
                export CLOUDANT_SECRET_NAME="binding-refarch-cloudantdb"
                export REGISTRY_NAMESPACE=chrisking

                cat customer.yaml | \
                yaml w - spec.template.spec.containers[0].image registry.ng.bluemix.net/${env.REGISTRY_NAMESPACE}/micro-customer:${env.BUILD_NUMBER} | \
                yaml w - spec.template.spec.containers[0].volumeMounts[0].mountPath /var/run/secrets/binding-refarch-cloudantdb | \
                yaml w - spec.template.spec.containers[0].volumeMounts[0].name binding-refarch-cloudantdb | \
                yaml w - spec.template.spec.volumes[0].name binding-refarch-cloudantdb | \
                yaml w - spec.template.spec.volumes[0].secret.defaultMode 420 | \
                yaml w - spec.template.spec.volumes[0].secret.secretName ${env.CLOUDANT_SECRET_NAME} \
                > deployment.yml

                # TODO: rolling update
                kubectl --token=`cat /var/run/secrets/kubernetes.io/serviceaccount/token` create -f deployment.yml
                kubectl --token=`cat /var/run/secrets/kubernetes.io/serviceaccount/token` create -f customer-service.yml
                """
            }
            stage ('Clean up old images') {
                sh """
                #!/bin/bash
                
                # TODO: delete old images 

                """
            }

        }
    }
}
